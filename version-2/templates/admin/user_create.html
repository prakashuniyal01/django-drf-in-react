{% extends 'admin/dashboard.html' %}
{% block title %}Create User{% endblock %}
{% block content %}
<div class="user-create-container" style="max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);">
    <h2 style="text-align: center; color: #333;">Create User</h2>
    <form id="createUserForm" style="display: flex; flex-direction: column; gap: 15px;">
        <div>
            <label for="full_name" style="display: block; font-weight: bold;">Full Name:</label>
            <input type="text" id="full_name" name="full_name" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" required>
        </div>
        
        <div>
            <label for="email" style="display: block; font-weight: bold;">Email:</label>
            <input type="email" id="email" name="email" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" required>
        </div>
        
        <div>
            <label for="password" style="display: block; font-weight: bold;">Password:</label>
            <input type="password" id="password" name="password" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" required>
        </div>
        
        <div>
            <label for="confirm_password" style="display: block; font-weight: bold;">Confirm Password:</label>
            <input type="password" id="confirm_password" name="confirm_password" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" required>
        </div>
        
        <div>
            <label for="role" style="display: block; font-weight: bold;">Role:</label>
            <select id="role" name="role" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" required>
                <option value="editor">Editor</option>
                <option value="journalist">Journalist</option>
            </select>
        </div>
        
        <div>
            <label for="number" style="display: block; font-weight: bold;">Number:</label>
            <input type="text" id="number" name="number" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" required>
        </div>
        
        <button type="submit" style="padding: 10px; background-color: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Create User</button>
    </form>
</div>

<!-- Modal for OTP Verification -->
<div id="otpModal" style="display: none; max-width: 400px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
    <h3 style="color: #333;">Verify Email</h3>
    <form id="verifyOtpForm" style="display: flex; flex-direction: column; gap: 15px;">
        <div>
            <label for="otp_email" style="display: block; font-weight: bold;">Email:</label>
            <input type="email" id="otp_email" name="email" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" required readonly>
        </div>
        
        <div>
            <label for="otp" style="display: block; font-weight: bold;">OTP:</label>
            <input type="text" id="otp" name="otp" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" required>
        </div>
        
        <button type="submit" style="padding: 10px; background-color: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Verify OTP</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const createUserForm = document.getElementById("createUserForm");
        const otpModal = document.getElementById("otpModal");
        const verifyOtpForm = document.getElementById("verifyOtpForm");
        const otpEmailField = document.getElementById("otp_email");
    
        // User creation logic
        createUserForm.addEventListener("submit", async (e) => {
            e.preventDefault();
    
            const formData = {
                full_name: document.getElementById("full_name").value,
                email: document.getElementById("email").value,
                password: document.getElementById("password").value,
                confirm_password: document.getElementById("confirm_password").value,
                role: document.getElementById("role").value,
                number: document.getElementById("number").value,
            };
    
            try {
                const response = await fetch("/users/admin/users/", {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });
    
                if (response.ok) {
                    const data = await response.json();
                    alert("User created successfully. Please verify OTP to activate the account.");
    
                    // Autofill email in modal and display it
                    otpEmailField.value = formData.email;
                    otpModal.style.display = "block"; // Show the OTP modal
                } else {
                    const errorData = await response.json();
                    alert("Error creating user: " + errorData.message);
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An unexpected error occurred.");
            }
        });
    
        // OTP verification logic
        verifyOtpForm.addEventListener("submit", async (e) => {
            e.preventDefault();
    
            const otpData = {
                email: otpEmailField.value,
                otp: document.getElementById("otp").value,
            };
    
            try {
                const response = await fetch("/users/register-verify-otp/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(otpData),
                });
    
                if (response.ok) {
                    alert("OTP verified successfully. User is now active.");
                    otpModal.style.display = "none"; // Close the OTP modal
                } else {
                    const errorData = await response.json();
                    alert("Error verifying OTP: " + errorData.message);
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An unexpected error occurred.");
            }
        });
    });
    
    </script>
    
{% endblock %}
