<!-- admin/article_update.html -->
{% extends 'admin/dashboard.html' %}
{% block title %}Update Article{% endblock %}
{% block content %}
<div class="container mt-5">
    <h2>Update Article</h2>
    <form id="update-article-form">
        <!-- Title -->
        <div class="mb-3">
            <label for="title" class="form-label"><strong>Title</strong></label>
            <input type="text" class="form-control" id="title" required>
        </div>

        <!-- Subtitle -->
        <div class="mb-3">
            <label for="subtitle" class="form-label"><strong>Subtitle</strosng></label>
            <input type="text" class="form-control" id="subtitle">
        </div>

        <!-- Content -->
        <div class="mb-3">
            <label for="content" class="form-label"><strong>Content</strong></label>
            <textarea class="form-control" id="contents" rows="5" required></textarea>
        </div>

        <!-- Status -->
        <div class="mb-3">
            <label for="status" class="form-label"><strong>Status</strong></label>
            <select class="form-select" id="status" required>
                <option value="">Select Status</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="published">Published</option>
            </select>
        </div>

        <!-- Publish Date -->
        <div class="mb-3">
            <label for="publish_date" class="form-label"><strong>Publish Date</strong></label>
            <input type="datetime-local" class="form-control" id="publish_date">
        </div>

        <!-- Categories -->
        <div class="mb-3">
            <label for="categories" class="form-label"><strong>Categories</strong></label>
            <input type="text" class="form-control" id="categories" placeholder="Comma-separated categories">
        </div>

        <!-- Tags -->
        <div class="mb-3">
            <label for="tags" class="form-label"><strong>Tags</strong></label>
            <input type="text" class="form-control" id="tags" placeholder="Comma-separated tags">
        </div>

        <!-- Map -->
        <div class="mb-3">
            <label for="map" class="form-label"><strong>Map</strong></label>
            <div id="map" style="height: 300px;"></div>
        </div>

        <!-- Location -->
        <div class="mb-3">
            <label for="location" class="form-label"><strong>Location</strong></label>
            <input type="text" class="form-control" id="location" placeholder="City, State, Country">
        </div>

        <!-- Latitude -->
        <div class="mb-3">
            <label for="latitude" class="form-label"><strong>Latitude</strong></label>
            <input type="number" step="any" class="form-control" id="latitude">
        </div>

        <!-- Longitude -->
        <div class="mb-3">
            <label for="longitude" class="form-label"><strong>Longitude</strong></label>
            <input type="number" step="any" class="form-control" id="longitude">
        </div>

        <!-- Author -->
        {% comment %} <div class="mb-3">
            <label for="author" class="form-label"><strong>Author</strong></label>
            <input type="text" class="form-control" id="author" required>
        </div> {% endcomment %}

        <!-- Images -->
        <div class="mb-3">
            <label for="images" class="form-label"><strong>Images</strong></label>
            <input type="file" class="form-control" id="images" multiple accept="image/*">
            <div id="existing-images" class="mt-2">
                <!-- Existing images will be displayed here -->
            </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-success">Update Article</button>
        <button type="button" id="cancel-btn" class="btn btn-secondary" style="margin-left: 10px;">Cancel</button>
    </form>
</div>

<!-- Include Leaflet.js for map functionality -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Include Bootstrap JS for any components if needed -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const urlParts = window.location.pathname.split('/');
        const articleId = urlParts[urlParts.length - 2] || urlParts[urlParts.length - 1];
        console.log("Article ID for Update:", articleId);

        let map, marker;

        async function fetchArticleDetail() {
            try {
                const response = await fetch(`/articles/articles/admin/${articleId}/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    populateForm(data);
                } else {
                    console.error("Failed to fetch article details for update");
                }
            } catch (error) {
                console.error("Error fetching article details:", error);
            }
        }

        function populateForm(article) {
            console.log(article)
            document.getElementById("title").value = article.title || '';
            document.getElementById("subtitle").value = article.subtitle || '';
            document.getElementById("contents").value = article.content || '';
            document.getElementById("status").value = article.status || '';
            if (article.publish_date) {
                const publishDate = new Date(article.publish_date);
                document.getElementById("publish_date").value = publishDate.toISOString().slice(0,16);
            }
            document.getElementById("categories").value = article.categories.map(cat => cat.name).join(", ");
            document.getElementById("tags").value = article.tags.map(tag => tag.name).join(", ");
            document.getElementById("location").value = `${article.city.name}, ${article.city.state}, ${article.city.country}`;
            document.getElementById("latitude").value = article.latitude || '';
            document.getElementById("longitude").value = article.longitude || '';

            // Set map and marker location
            const lat = article.latitude || 20.5937;
            const lng = article.longitude || 78.9629;
            map.setView([lat, lng], 10);
            marker.setLatLng([lat, lng]);

            // Display existing images
            const existingImagesContainer = document.getElementById("existing-images");
            existingImagesContainer.innerHTML = '';
            if (article.images && article.images.length > 0) {
                article.images.forEach((image, index) => {
                    const imgDiv = document.createElement("div");
                    imgDiv.classList.add("mb-2");
                    imgDiv.innerHTML = `
                        <img src="${image.image}" alt="Image ${index + 1}" class="img-thumbnail" width="150">
                        <button type="button" class="btn btn-danger btn-sm ms-2 remove-image-btn" data-image-id="${image.id}">Remove</button>
                    `;
                    existingImagesContainer.appendChild(imgDiv);
                });
            }
        }

        // Initialize map
        map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Add a draggable marker
        marker = L.marker([20.5937, 78.9629], { draggable: true }).addTo(map);

        // Update location fields when marker is moved
        marker.on('moveend', async (event) => {
            const position = event.target.getLatLng();
            document.getElementById("latitude").value = position.lat.toFixed(6);
            document.getElementById("longitude").value = position.lng.toFixed(6);

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.lat}&lon=${position.lng}`);
                if (response.ok) {
                    const data = await response.json();
                    const city = data.address.city || data.address.town || data.address.village || '';
                    const state = data.address.state || '';
                    const country = data.address.country || '';
                    document.getElementById("location").value = `${city}, ${state}, ${country}`;
                } else {
                    console.error("Failed to fetch location details");
                }
            } catch (error) {
                console.error("Error during reverse geocoding:", error);
            }
        });

        document.getElementById("update-article-form").addEventListener("submit", async (event) => {
            event.preventDefault(); // Prevent the default form submission behavior
        
            const urlParts = window.location.pathname.split('/');
            const articleId = urlParts[urlParts.length - 2] || urlParts[urlParts.length - 1];
        
            const updatedData = {
                title: document.getElementById("title").value,
                subtitle: document.getElementById("subtitle").value,
                content: document.getElementById("contents").value,
                status: document.getElementById("status").value,
                publish_date: document.getElementById("publish_date").value,
                categories: document.getElementById("categories").value.split(',').map(cat => cat.trim()),
                tags: document.getElementById("tags").value.split(',').map(tag => tag.trim()),
                latitude: parseFloat(document.getElementById("latitude").value),
                longitude: parseFloat(document.getElementById("longitude").value),
                location: document.getElementById("location").value,
            };
        
            // Prepare FormData if images need to be uploaded
            const formData = new FormData();
            for (const [key, value] of Object.entries(updatedData)) {
                if (key === "categories" || key === "tags") {
                    value.forEach(item => formData.append(key, item));
                } else {
                    formData.append(key, value);
                }
            }
        
            const imagesInput = document.getElementById("images");
            for (const file of imagesInput.files) {
                formData.append("images", file);
            }
        
            try {
                const response = await fetch(`/articles/articles/admin/${articleId}/`, {
                    method: "PUT",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        // Omit 'Content-Type' because `fetch` automatically sets the correct headers for `FormData`
                    },
                    body: formData
                });
        
                if (response.ok) {
                    const result = await response.json();
                    alert("Article updated successfully!");
                    console.log(result);
                } else {
                    const errorData = await response.json();
                    console.error("Failed to update article:", errorData);
                    alert("Failed to update article. Please check the input and try again.");
                }
            } catch (error) {
                console.error("Error updating article:", error);
                alert("An unexpected error occurred. Please try again.");
            }
        });
        

        // Fetch and populate article details
        fetchArticleDetail();
    });
</script>
{% endblock %}
