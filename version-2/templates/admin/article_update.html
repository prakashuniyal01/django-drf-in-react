<!-- admin/article_update.html -->
{% extends 'admin/dashboard.html' %}
{% block title %}Update Article{% endblock %}
{% block content %}
<div class="container mt-5">
    <h2>Update Article</h2>
    <form id="update-article-form">
        <!-- Title -->
        <div class="mb-3">
            <label for="title" class="form-label"><strong>Title</strong></label>
            <input type="text" class="form-control" id="title" required>
        </div>

        <!-- Subtitle -->
        <div class="mb-3">
            <label for="subtitle" class="form-label"><strong>Subtitle</strong></label>
            <input type="text" class="form-control" id="subtitle">
        </div>

        <!-- Content -->
        <div class="mb-3">
            <label for="content" class="form-label"><strong>Content</strong></label>
            <textarea class="form-control" id="content" rows="5" required></textarea>
        </div>

        <!-- Status -->
        <div class="mb-3">
            <label for="status" class="form-label"><strong>Status</strong></label>
            <select class="form-select" id="status" required>
                <option value="">Select Status</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="published">Published</option>
            </select>
        </div>

        <!-- Publish Date -->
        <div class="mb-3">
            <label for="publish_date" class="form-label"><strong>Publish Date</strong></label>
            <input type="datetime-local" class="form-control" id="publish_date">
        </div>

        <!-- Categories -->
        <div class="mb-3">
            <label for="categories" class="form-label"><strong>Categories</strong></label>
            <input type="text" class="form-control" id="categories" placeholder="Comma-separated categories">
        </div>

        <!-- Tags -->
        <div class="mb-3">
            <label for="tags" class="form-label"><strong>Tags</strong></label>
            <input type="text" class="form-control" id="tags" placeholder="Comma-separated tags">
        </div>

        <!-- Location -->
        <div class="mb-3">
            <label for="location" class="form-label"><strong>Location</strong></label>
            <input type="text" class="form-control" id="location" placeholder="City, State, Country">
        </div>

        <!-- Latitude -->
        <div class="mb-3">
            <label for="latitude" class="form-label"><strong>Latitude</strong></label>
            <input type="number" step="any" class="form-control" id="latitude">
        </div>

        <!-- Longitude -->
        <div class="mb-3">
            <label for="longitude" class="form-label"><strong>Longitude</strong></label>
            <input type="number" step="any" class="form-control" id="longitude">
        </div>

        <!-- Author -->
        <div class="mb-3">
            <label for="author" class="form-label"><strong>Author</strong></label>
            <input type="text" class="form-control" id="author" required>
        </div>

        <!-- Images -->
        <div class="mb-3">
            <label for="images" class="form-label"><strong>Images</strong></label>
            <input type="file" class="form-control" id="images" multiple accept="image/*">
            <div id="existing-images" class="mt-2">
                <!-- Existing images will be displayed here -->
            </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-success">Update Article</button>
        <button type="button" id="cancel-btn" class="btn btn-secondary" style="margin-left: 10px;">Cancel</button>
    </form>
</div>

<!-- Include Leaflet.js if needed for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Include Bootstrap JS for any components if needed -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const urlParts = window.location.pathname.split('/');
        const articleId = urlParts[urlParts.length - 2] || urlParts[urlParts.length - 1];
        console.log("Article ID for Update:", articleId);

        async function fetchArticleDetail() {
            try {
                const response = await fetch(`/articles/articles/admin/${articleId}/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    populateForm(data);
                } else {
                    console.error("Failed to fetch article details for update");
                }
            } catch (error) {
                console.error("Error fetching article details:", error);
            }
        }

        function populateForm(article) {
            document.getElementById("title").value = article.title || '';
            document.getElementById("subtitle").value = article.subtitle || '';
            document.getElementById("content").value = article.content || '';
            document.getElementById("status").value = article.status || '';
            if (article.publish_date) {
                const publishDate = new Date(article.publish_date);
                document.getElementById("publish_date").value = publishDate.toISOString().slice(0,16);
            }
            document.getElementById("categories").value = article.categories.map(cat => cat.name).join(", ");
            document.getElementById("tags").value = article.tags.map(tag => tag.name).join(", ");
            document.getElementById("location").value = `${article.city.name}, ${article.city.state}, ${article.city.country}`;
            document.getElementById("latitude").value = article.latitude || '';
            document.getElementById("longitude").value = article.longitude || '';
            document.getElementById("author").value = article.author_name || '';

            // Display existing images
            const existingImagesContainer = document.getElementById("existing-images");
            existingImagesContainer.innerHTML = '';
            if (article.images && article.images.length > 0) {
                article.images.forEach((image, index) => {
                    const imgDiv = document.createElement("div");
                    imgDiv.classList.add("mb-2");
                    imgDiv.innerHTML = `
                        <img src="${image.image}" alt="Image ${index + 1}" class="img-thumbnail" width="150">
                        <button type="button" class="btn btn-danger btn-sm ms-2 remove-image-btn" data-image-id="${image.id}">Remove</button>
                    `;
                    existingImagesContainer.appendChild(imgDiv);
                });
            }
        }

        async function updateArticle(event) {
            event.preventDefault();

            const title = document.getElementById("title").value;
            const subtitle = document.getElementById("subtitle").value;
            const content = document.getElementById("content").value;
            const status = document.getElementById("status").value;
            const publish_date = document.getElementById("publish_date").value;
            const categories = document.getElementById("categories").value.split(',').map(cat => cat.trim());
            const tags = document.getElementById("tags").value.split(',').map(tag => tag.trim());
            const location = document.getElementById("location").value;
            const latitude = parseFloat(document.getElementById("latitude").value);
            const longitude = parseFloat(document.getElementById("longitude").value);
            const author = document.getElementById("author").value;
            const images = document.getElementById("images").files;

            // Assuming location is in "City, State, Country" format
            const [cityName, state, country] = location.split(',').map(part => part.trim());

            // Create FormData for multipart/form-data
            const formData = new FormData();
            formData.append('title', title);
            formData.append('subtitle', subtitle);
            formData.append('content', content);
            formData.append('status', status);
            formData.append('publish_date', publish_date);
            formData.append('categories', JSON.stringify(categories));
            formData.append('tags', JSON.stringify(tags));
            formData.append('city_name', cityName);
            formData.append('state', state);
            formData.append('country', country);
            formData.append('latitude', latitude);
            formData.append('longitude', longitude);
            formData.append('author_name', author);

            // Append new images
            for (let i = 0; i < images.length; i++) {
                formData.append('images', images[i]);
            }

            try {
                const response = await fetch(`/articles/articles/admin/${articleId}/`, {
                    method: 'PUT', // or 'PATCH' based on your API
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        // 'Content-Type': 'multipart/form-data', // Do not set this header when using FormData
                    },
                    body: formData
                });

                if (response.ok) {
                    alert("Article updated successfully!");
                    window.location.href = `/admin_article_detail/${articleId}/`; // Adjust the URL as needed
                } else {
                    const errorData = await response.json();
                    console.error("Failed to update article:", errorData);
                    alert("Failed to update article. Check console for details.");
                }
            } catch (error) {
                console.error("Error updating article:", error);
                alert("An error occurred while updating the article.");
            }
        }

        // Handle form submission
        document.getElementById("update-article-form").addEventListener("submit", updateArticle);

        // Handle cancel button
        document.getElementById("cancel-btn").addEventListener("click", () => {
            window.location.href = `/admin_article/${articleId}/`; // Adjust the URL as needed
        });

        // Handle removing existing images (optional)
        document.getElementById("existing-images").addEventListener("click", async (event) => {
            if (event.target.classList.contains("remove-image-btn")) {
                const imageId = event.target.getAttribute("data-image-id");
                const confirmation = confirm("Are you sure you want to remove this image?");
                if (!confirmation) return;

                try {
                    const response = await fetch(`/articles/images/${imageId}/`, { // Adjust the URL based on your API
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json',
                        },
                    });

                    if (response.ok) {
                        alert("Image removed successfully!");
                        // Remove the image element from the DOM
                        event.target.parentElement.remove();
                    } else {
                        console.error("Failed to remove image");
                        alert("Failed to remove image.");
                    }
                } catch (error) {
                    console.error("Error removing image:", error);
                    alert("An error occurred while removing the image.");
                }
            }
        });

        fetchArticleDetail();
    });
</script>
{% endblock %}
