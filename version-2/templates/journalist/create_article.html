{% extends 'base.html' %}
{% block title %}Create Article{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Create Article</h2>
    
    <!-- Step 1 -->
    <div id="step1">
        <h4>Step 1: Article Details</h4>
        <form id="form-step1">
            <div class="form-group">
                <label for="title">Title:</label>
                <input type="text" id="title" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="subtitle">Subtitle:</label>
                <input type="text" id="subtitle" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="content">Content:</label>
                <textarea id="content" class="form-control" rows="5" required></textarea>
            </div>
            <div class="form-group">
                <label for="publish_date">Publish Date:</label>
                <input type="datetime-local" id="publish_date" class="form-control" required>
            </div>
            <button type="button" class="btn btn-primary" id="next-step1">Next</button>
        </form>
    </div>

    <!-- Step 2 -->
    <div id="step2" style="display: none;">
        <h4>Step 2: Additional Details</h4>
        <form id="form-step2" enctype="multipart/form-data">
            <!-- Create New Category -->
            <div class="form-group">
                <label for="category">Category:</label>
                <input type="text" id="category" class="form-control" placeholder="Enter category" required>
            </div>
            
            <!-- Create New Tags -->
            <div class="form-group">
                <label for="tags">Tags:</label>
                <div>
                    <input type="text" id="tag1" class="form-control" placeholder="Enter tag" />
                    <input type="text" id="tag2" class="form-control" placeholder="Enter another tag" />
                    <input type="text" id="tag3" class="form-control" placeholder="Enter another tag" />
                    <!-- Add more input fields as needed -->
                </div>
            </div>
            
            <div class="form-group">
                <label for="images">Upload Images:</label>
                <input type="file" id="images" class="form-control-file" multiple required>
            </div>
            <div class="form-group">
                <label for="city">City:</label>
                <input type="text" id="city" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="state">State:</label>
                <input type="text" id="state" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="country">Country:</label>
                <input type="text" id="country" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="agreed_to_terms">
                    <input type="checkbox" id="agreed_to_terms" required>
                    I agree to the terms and conditions.
                </label>
            </div>
            <div id="map" style="height: 400px; margin-top: 20px;"></div>
            <br>
            <button type="button" class="btn btn-secondary" id="prev-step2">Back</button>
            <button type="button" class="btn btn-success" id="submit-form">Submit</button>
        </form>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // Fetch access token from localStorage or session
    const accessToken = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');

    // Check if access token is available and valid
    if (!accessToken) {
        alert('You are not logged in. Redirecting to login page.');
        window.location.href = '/login/';
    }
    
    // Step navigation
    document.getElementById('next-step1').addEventListener('click', () => {
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
    });

    document.getElementById('prev-step2').addEventListener('click', () => {
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step1').style.display = 'block';
    });

    // Map integration with OpenStreetMap and reverse geocoding
    let latitude = 0;
    let longitude = 0;
    const map = L.map('map').setView([28.6139, 77.2090], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);

    const marker = L.marker([28.6139, 77.2090], { draggable: true }).addTo(map);

    marker.on('dragend', function (event) {
        const position = marker.getLatLng();
        latitude = position.lat;
        longitude = position.lng;
        console.log('Latitude:', latitude, 'Longitude:', longitude);

        // Call reverse geocoding API
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch location data');
                }
                return response.json();
            })
            .then(data => {
                const city = data.address.city || data.address.town || data.address.village || '';
                const state = data.address.state || '';
                const country = data.address.country || '';

                // Populate fields
                document.getElementById('city').value = city;
                document.getElementById('state').value = state;
                document.getElementById('country').value = country;

                console.log('City:', city, 'State:', state, 'Country:', country);
            })
            .catch(error => {
                console.error('Error fetching location:', error);
            });
    });

    // Form submission
    document.getElementById('submit-form').addEventListener('click', () => {
        const formData = new FormData();
    
        formData.append('title', document.getElementById('title').value);
        formData.append('subtitle', document.getElementById('subtitle').value);
        formData.append('content', document.getElementById('content').value);
        formData.append('publish_date', document.getElementById('publish_date').value);
    
        // Category (Text input)
        const category = document.getElementById('category').value;
        formData.append('category', category);
    
        // Tags (Text inputs)
        const tags = [];
        if (document.getElementById('tag1').value) tags.push(document.getElementById('tag1').value);
        if (document.getElementById('tag2').value) tags.push(document.getElementById('tag2').value);
        if (document.getElementById('tag3').value) tags.push(document.getElementById('tag3').value);
        tags.forEach(tag => formData.append('tags', tag));
    
        // Other form fields (e.g., images, location, etc.)
        const images = document.getElementById('images').files;
        for (let i = 0; i < images.length; i++) {
            formData.append('images', images[i]);
        }
    
        const locationData = {
            name: document.getElementById('city').value,
            state: {
                name: document.getElementById('state').value,
                country: {
                    name: document.getElementById('country').value,
                },
            },
        };
    
        formData.append('location', JSON.stringify(locationData));
        formData.append('latitude', latitude.toFixed(6));
        formData.append('longitude', longitude.toFixed(6));
    
        // Agreed to terms checkbox
        const agreedToTerms = document.getElementById('agreed_to_terms').checked;
        formData.append('agreed_to_terms', agreedToTerms);
    
        // Ensure agreement checkbox is checked
        if (!agreedToTerms) {
            alert('You must agree to the terms and conditions!');
            return;
        }
    
        // Submit the form
        fetch('http://localhost:8000/articles/articles/', {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${accessToken}`,
            },
            body: formData,
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to create article');
            }
            return response.json();
        })
        .then(result => {
            alert('Article created successfully');
            console.log(result);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
</script>

{% endblock %}
