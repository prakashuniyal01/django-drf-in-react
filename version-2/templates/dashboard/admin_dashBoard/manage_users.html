<!-- Main container for the user list -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  rel="stylesheet" />
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css"
  rel="stylesheet" />
<style>
  .profile-cart {
    position: absolute;
    top: 50px;
    right: 10px;
    width: 300px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
    padding: 15px;
    display: none;
    z-index: 999;
  }

  .profile-cart img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 15px;
  }

  #profile-icon {
    border-radius: 50%;
    width: 40px;
    height: 40px;
  }

  footer a:hover {
    color: #ffd700;
    /* Gold color on hover */
  }
</style>
<div class="container mt-5">
  <h1 class="text-center mb-4">User List</h1>
  <div>
    <label for="role-filter">Filter by Role: </label>
    <select id="role-filter" class="form-select">
      <option value="">All Roles</option>
      <option value="editor">Editor</option>
      <option value="journalist">Journalist</option>
      <option value="admin">Admin</option>
    </select>
  </div>
  <div id="user-list"></div>

  <div id="user-list">
    <!-- User data will be dynamically inserted here -->
  </div>
  <div
    class="modal fade"
    id="updateModal"
    tabindex="-1"
    aria-labelledby="updateModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateModalLabel">Update User</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="update-form">
            <div class="mb-3">
              <label for="full-name" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="full-name" required />
            </div>
            <div class="mb-3">
              <label for="email-modal" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                id="email-modal"
                required />
            </div>
            <div class="mb-3">
              <label for="number-modal" class="form-label">Phone Number</label>
              <input
                type="number"
                maxlength="12"
                class="form-control"
                id="number-modal"
                required />
            </div>
            <div class="mb-3">
              <label for="role" class="form-label">Role</label>
              <select class="form-control" id="role" required>
                <option value="journalist">Journalist</option>
                <option value="editor">Editor</option>
                <!-- <option value="user">User</option> -->
              </select>
            </div>
            <div class="mb-3">
              <label for="is-active" class="form-label">Active Status</label>
              <select class="form-control" id="is-active" required>
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="is-staff" class="form-label">Staff Status</label>
              <select class="form-control" id="is-staff" required>
                <option value="true">Staff</option>
                <option value="false">Non-Staff</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Update</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const apiEndpoint = "/users/admin/users/";
  const accessToken = localStorage.getItem("access_token");

  // Fetch and display users
  let displayedUsers = 0; // Track how many users have been displayed
  const batchSize = 2; // Number of users to show per batch

  // Add event listener for role filter dropdown
  document.addEventListener("DOMContentLoaded", function () {
    fetchUsers(); // This will run when the page is loaded
  });
  document.getElementById("role-filter").addEventListener("change", fetchUsers);

  // Common function to handle API requests (GET, POST, PUT, DELETE)
  async function apiRequest(endpoint, method = "GET", body = null) {
    // Check if the access token is available
    if (!accessToken) {
      alert("Access token not found. Please login.");
      return;
    }

    // Define the request options
    const options = {
      method, // HTTP method (GET, POST, PUT, DELETE)
      headers: {
        Authorization: `Bearer ${accessToken}`,
        "Content-Type": "application/json",
      },
    };

    // If there is a body (for PUT, POST), include it in the request
    if (body) {
      options.body = JSON.stringify(body);
    }

    try {
      // Make the API request
      const response = await fetch(endpoint, options);

      // Check if the response is OK (status 200-299)
      if (!response.ok) {
        throw new Error(`Error fetching data: ${response.statusText}`);
      }

      // Return the JSON response data
      return await response.json();
    } catch (error) {
      console.error("API Request Error:", error);
      alert("Failed to load data. Please try again later.");
    }
  }

  // Fetch users and display them with optional filtering by role
  async function fetchUsers() {
    const roleFilter = document.getElementById("role-filter").value; // Get selected role filter

    try {
      // Call API to fetch users
      const users = await apiRequest(apiEndpoint);

      console.log({ users });
      // Filter users based on the selected role (if any)
      const filteredUsers = roleFilter
        ? users.filter((user) => user.role.toLowerCase() === roleFilter)
        : users;

      // Display the filtered users
      displayUsers(filteredUsers);
    } catch (error) {
      console.error("Error fetching users:", error);
      alert("Failed to load user data. Please try again later.");
    }
  }

  // Function to display users in the list with pagination
  function displayUsers(users) {
    const userListDiv = document.getElementById("user-list");
    userListDiv.innerHTML = ""; // Clear existing list

    // If no users are found, display a message
    if (users.length === 0) {
      userListDiv.innerHTML = "<p>No users found.</p>";
      return;
    }

    // Create a new list element
    const ul = document.createElement("ul");
    ul.classList.add("list-group");

    // Display only a batch of users based on the batchSize
    for (let i = 0; i < Math.min(batchSize, users.length); i++) {
      const user = users[i];
      const li = document.createElement("li");
      li.classList.add(
        "list-group-item",
        "d-flex",
        "justify-content-between",
        "align-items-center"
      );

      // Add user details to the list item
      li.innerHTML = `
    <div>
        <strong>${user.full_name}</strong><br>
        <small>Email: ${user.email}</small><br>
        <small>Role: ${user.role}</small><br>
        <small>Phone: ${user.number}</small>
    </div>
    <div>
        <span class="badge ${user.is_active ? "bg-success" : "bg-danger"}">${
        user.is_active ? "Active" : "Inactive"
      }</span>
        {% comment %} <span class="badge ${
          user.is_staff ? "bg-info" : "bg-secondary"
        }">${user.is_staff ? "Staff" : "Non-Staff"}</span> {% endcomment %}
        <button class="btn btn-warning btn-sm ms-2" onclick="openEditModal(${
          user.id
        })">Edit</button>
        <button class="btn btn-danger btn-sm ms-2" onclick="deleteUser(${
          user.id
        })">Delete</button>
    </div>
  `;

      ul.appendChild(li);
    }

    userListDiv.appendChild(ul);

    // If there are more users to display, show the "Show More" button
    if (users.length > batchSize) {
      const showMoreButton = document.createElement("button");
      showMoreButton.classList.add("btn", "btn-primary", "mt-3");
      showMoreButton.innerText = "Show More";
      showMoreButton.onclick = () => showMore(users);
      userListDiv.appendChild(showMoreButton);
    }
  }
  // Delete user via DELETE request
  async function deleteUser(userId) {
    const confirmDelete = confirm("Are you sure you want to delete this user?");
    if (confirmDelete) {
      try {
        // Call API to delete the user
        await apiRequest(`${apiEndpoint}${userId}/`, "DELETE");
        alert("User deleted successfully");
        fetchUsers(); // Re-fetch the user list after deletion
      } catch (error) {
        console.error("Error deleting user:", error);
        alert("Failed to delete user. Please try again.");
      }
    }
  }

  // Open the modal to edit user data
  async function openEditModal(userId) {
    try {
      // Fetch the user data for editing
      const user = await apiRequest(`${apiEndpoint}${userId}/`);
      console.log(user);
      if (user) {
        // Populate the modal form with the user's data
        // Assuming the user object contains the necessary data
        document.getElementById("full-name").value = user.full_name;
        document.getElementById("email-modal").value = user.email;
        document.getElementById("number-modal").value = user.number;
        document.getElementById("role").value = user.role;
        document.getElementById("is-active").value = user.is_active.toString();
        document.getElementById("is-staff").value = user.is_staff.toString();

        // Disable all fields except role and is-active
        const fieldsToDisable = [
          "full-name",
          "email-modal",
          "number-modal",
          "is-staff",
        ];

        fieldsToDisable.forEach(function (id) {
          document.getElementById(id).disabled = true; // Disable these fields
        });

        // role and is-active will remain enabled by default
        document.getElementById("role").disabled = false; // Ensure role is enabled
        document.getElementById("is-active").disabled = false;

        // Set form submission handler to update the user
        document.getElementById("update-form").onsubmit = (e) => {
          e.preventDefault();
          updateUser(userId);
        };

        // Show the modal
        new bootstrap.Modal(document.getElementById("updateModal")).show();
      }
    } catch (error) {
      console.error("Error loading user data for edit:", error);
      alert("Failed to load user data for editing.");
    }
  }
  // Fetch and display users on page load
  window.onload = fetchUsers;
  // Function to show more users as the "Show More" button is clicked
  function showMore(users) {
    displayedUsers += batchSize; // Increase the number of displayed users
    const remainingUsers = users.slice(
      displayedUsers,
      displayedUsers + batchSize
    ); // Get the next batch of users
    const ul = document.querySelector("#user-list ul");

    // Add remaining users to the list
    remainingUsers.forEach((user) => {
      const li = document.createElement("li");
      li.classList.add(
        "list-group-item",
        "d-flex",
        "justify-content-between",
        "align-items-center"
      );

      li.innerHTML = `
    <div>
        <strong>${user.full_name}</strong><br>
        <small>Email: ${user.email}</small><br>
        <small>Role: ${user.role}</small><br>
        <small>Phone: ${user.number}</small>
    </div>
    <div>
        <span class="badge ${user.is_active ? "bg-success" : "bg-danger"}">${
        user.is_active ? "Active" : "Inactive"
      }</span>
        <span class="badge ${user.is_staff ? "bg-info" : "bg-secondary"}">${
        user.is_staff ? "Staff" : "Non-Staff"
      }</span>
        <button class="btn btn-warning btn-sm ms-2" onclick="openEditModal(${
          user.id
        })">Edit</button>
        <button class="btn btn-danger btn-sm ms-2" onclick="deleteUser(${
          user.id
        })">Delete</button>
    </div>
  `;
      ul.appendChild(li);
    });

    // If there are still more users, show the "Show More" button again
    // if (displayedUsers + batchSize < users.length) {
    //   const showMoreButton = document.createElement("button");
    //   showMoreButton.classList.add("btn", "btn-primary", "mt-3");
    //   showMoreButton.innerText = "Show More";
    //   showMoreButton.onclick = () => showMore(users);
    //   document.getElementById("user-list").appendChild(showMoreButton);
    // }
  }

  // Update user data via PUT request
  async function updateUser(userId) {
    const updatedUser = {
      full_name: document.getElementById("full-name").value,
      email: document.getElementById("email-modal").value,
      number: document.getElementById("number-modal").value,
      role: document.getElementById("role").value,
      is_active: document.getElementById("is-active").value === "true",
      is_staff: document.getElementById("is-staff").value === "true",
    };

    try {
      // Call API to update the user
      const updatedData = await apiRequest(
        `${apiEndpoint}${userId}/`,
        "PUT",
        updatedUser
      );
      console.log("User updated successfully:", updatedData);
      alert("User updated successfully!");
      location.reload(); // Reload the page to reflect changes
    } catch (error) {
      console.error("Error updating user:", error);
      alert("Failed to update user.");
    }
  }
</script>
